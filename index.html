<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>E-Smart Market Pro â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØª</title>
  <meta name="theme-color" content="#D4AF37">

  <!-- Manifest Ù…Ø¶Ù…Ù‘Ù† Ø¹Ø¨Ø± Data URI -->
  <link rel="manifest" href="data:application/json;base64,ewogIm5hbWUiOiJFLVNtYXJ0IE1hcmtldCBQcm8iLCJzaG9ydF9uYW1lIjoiRS1TbWFydCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMEIwQjBCIiwi dGhlbWVfY29sb3IiOiIjRD RB RjM3In0=">

  <style>
    /* ========== CSS Ø¹Ø§Ù… Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ ========== */
    :root {
      --bg: #0B0B0B;
      --panel: #111317;
      --gold: #D4AF37;
      --green: #22C55E;
      --muted: #9CA3AF;
      --white: #fff;
      --warn: #f59e0b;
      --danger: #ef4444;
      --line: #1f2937;
    }
    * { box-sizing: border-box; }
    html,body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--white);
      font-family: system-ui,Segoe UI,Inter,Noto Sans Arabic,Arial;
      height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 40px; height: 40px;
      border-radius: 10px;
      background: #000;
      border: 2px solid var(--gold);
      display: grid;
      place-items: center;
      color: var(--gold);
      font-weight: bold;
    }
    h1 { margin: 0; color: var(--gold); font-size: 1.2em; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--gold);
      background: transparent;
      color: var(--white);
      cursor: pointer;
    }
    .btn.primary { background: var(--gold); color: #000; border: none; }
    .tabs {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    .tab {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #333;
      background: transparent;
      color: var(--white);
      cursor: pointer;
    }
    .tab.active {
      border-color: var(--gold);
      background: var(--panel);
      color: var(--gold);
    }
    .panel {
      flex: 1;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      overflow: auto;
    }
    .panel h2 {
      margin-top: 0;
      color: var(--gold);
      font-size: 1em;
    }

    /* ========== Overrides ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ========== */
    #pantry form, #pantry .stock-list { margin-bottom: 16px; }
    #pantry form input,
    #pantry form select,
    #pantry form button {
      margin: 4px;
      padding: 6px;
      border: 1px solid #333;
      border-radius: 6px;
      background: #0b0b0b;
      color: #fff;
    }
    #pantry .stock-list .item {
      background: var(--panel);
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #pantry .btn.export { background: #ff7b00; border:none; color:#000; }
    #pantry .btn.import { background: #004aad; border:none; color:#fff; }
    #pantry .btn.reset  { background: var(--danger); border:none; }
    #pantry .btn.edit   { background: #ffc107; border:none; color:#000; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="logo">e</div>
        <h1>E-Smart Market Pro</h1>
      </div>
      <div class="actions">
        <button class="btn primary" id="installBtn">â¬‡ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="home">Ø§Ù„Ù„ÙˆØ­Ø©</button>
      <button class="tab" data-tab="bills">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
      <button class="tab" data-tab="pantry">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
      <button class="tab" data-tab="calendar">Ø§Ù„Ø±Ø²Ù†Ø§Ù…Ø©</button>
    </div>

    <!-- Home -->
    <section id="home" class="panel">
      <h2>Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
      <p>Ù‡Ù†Ø§ ØªØ¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ£Ø´ÙƒØ§Ù„ Ø¨ÙŠØ§Ù†ÙŠØ©â€¦</p>
    </section>

    <!-- Bills -->
    <section id="bills" class="panel" style="display:none">
      <h2>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
      <p>ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªØ£ØªÙŠ Ù‡Ù†Ø§.</p>
    </section>

    <!-- Pantry (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) -->
    <section id="pantry" class="panel" style="display:none">
      <h2>Ø§Ù„Ù…Ø·Ø¨Ø® ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>

      <!-- Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ -->
      <form id="addProductForm">
        <input id="productName"    type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required>
        <input id="productUnit"    type="text" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© (mg/ml/pcâ€¦)" required>
        <input id="productTotal"   type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©" required>
        <button class="btn primary" id="submitBtn">Ø¥Ø¶Ø§ÙØ©</button>
      </form>

      <!-- Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ -->
      <form id="consumeForm">
        <select id="productSelect"></select>
        <input id="consumeAmount"  type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©" required>
        <button class="btn">Ø®ØµÙ…</button>
      </form>

      <!-- ØªØ­ÙƒÙ… ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ù…Ø³Ø­ -->
      <button class="btn export" id="exportBtn">ğŸ“¤ ØªØµØ¯ÙŠØ± JSON</button>
      <button class="btn import" id="importBtn">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
      <button class="btn reset"  id="resetBtn">ğŸ—‘ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">

      <!-- Ù‚Ø§Ø¦Ù…Ø© -->
      <div class="stock-list" id="stockList"></div>
    </section>

    <!-- Calendar -->
    <section id="calendar" class="panel" style="display:none">
      <h2>Ø§Ù„Ø±Ø²Ù†Ø§Ù…Ø©</h2>
      <p>ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù‡Ù†Ø§.</p>
    </section>
  </div>

  <script>
  // ===== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª =====
  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
      document.getElementById(tab.dataset.tab).style.display='block';
    };
  });

  // ===== ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† =====
  function initPantry(){
    let products = JSON.parse(localStorage.getItem("products"))||[];
    let editIndex = null;
    const refs = {
      addForm:       document.getElementById("addProductForm"),
      consumeForm:   document.getElementById("consumeForm"),
      exportBtn:     document.getElementById("exportBtn"),
      importBtn:     document.getElementById("importBtn"),
      resetBtn:      document.getElementById("resetBtn"),
      importFile:    document.getElementById("importFile"),
      productSelect: document.getElementById("productSelect"),
      stockList:     document.getElementById("stockList"),
      submitBtn:     document.getElementById("submitBtn"),
      nameInput:     document.getElementById("productName"),
      unitInput:     document.getElementById("productUnit"),
      totalInput:    document.getElementById("productTotal"),
      consumeInput:  document.getElementById("consumeAmount")
    };

    const saveData = ()=> {
      localStorage.setItem("products", JSON.stringify(products));
    };

    function updateUI(){
      // Dropdown
      refs.productSelect.innerHTML = "";
      products.forEach((p,i)=>{
        const o = document.createElement("option");
        o.value = i; o.textContent = p.name;
        refs.productSelect.appendChild(o);
      });
      // List
      refs.stockList.innerHTML = "";
      products.forEach((p,i)=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <span><strong>${p.name}</strong> â€” ${p.used}/${p.total}${p.unit}</span>
          <span><button class="btn edit" onclick="editProduct(${i})">âœï¸</button></span>
        `;
        refs.stockList.appendChild(div);
      });
    }

    window.editProduct = i=>{
      const p = products[i];
      refs.nameInput.value  = p.name;
      refs.unitInput.value  = p.unit;
      refs.totalInput.value = p.total;
      editIndex = i;
      refs.submitBtn.textContent = "ØªØ­Ø¯ÙŠØ«";
    };

    refs.addForm.onsubmit = e=>{
      e.preventDefault();
      const name  = refs.nameInput.value;
      const unit  = refs.unitInput.value;
      const total = +refs.totalInput.value;
      if(editIndex!==null){
        products[editIndex] = {...products[editIndex], name, unit, total};
        editIndex = null;
        refs.submitBtn.textContent = "Ø¥Ø¶Ø§ÙØ©";
      } else {
        products.push({name,unit,total,used:0});
      }
      saveData();
      updateUI();
      refs.addForm.reset();
    };

    refs.consumeForm.onsubmit = e=>{
      e.preventDefault();
      const i   = +refs.productSelect.value;
      const amt = +refs.consumeInput.value;
      if(products[i].total - products[i].used >= amt){
        products[i].used += amt;
        saveData();
        updateUI();
      } else alert("âš ï¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ!");
      refs.consumeForm.reset();
    };

    refs.exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(products,null,2)], {type:"application/json"});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href    = url;
      a.download= "stock-data.json";
      a.click();
      URL.revokeObjectURL(url);
    };

    refs.importBtn.onclick = ()=> refs.importFile.click();
    refs.importFile.onchange = e=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{
        try {
          const arr = JSON.parse(ev.target.result);
          if(Array.isArray(arr)){
            products = arr;
            saveData();
            updateUI();
            alert("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
          } else throw "";
        } catch {
          alert("âš ï¸ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
        }
      };
      r.readAsText(f);
    };

    refs.resetBtn.onclick = ()=>{
      if(confirm("âš ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")){
        products=[];
        localStorage.removeItem("products");
        updateUI();
        alert("âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­!");
      }
    };

    updateUI();
  }
  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  document.querySelector('[data-tab="pantry"]').addEventListener('click', initPantry);

  // ===== PWA & Service Worker =====
  if('serviceWorker' in navigator){
    // ÙƒÙˆØ¯ SW ÙƒÙ€ Blob Ù„ØªØ¶Ù…ÙŠÙ†Ù‡ Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù
    const swCode = `
      const CACHE = 'esmart-cache-v1';
      self.addEventListener('install', e=>{
        e.waitUntil(
          caches.open(CACHE).then(c=>c.addAll([
            './',
          ]))
        );
        self.skipWaiting();
      });
      self.addEventListener('fetch', e=>{
        e.respondWith(
          caches.match(e.request).then(r=>r||fetch(e.request))
        );
      });
    `;
    const blob = new Blob([swCode],{type:'text/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).catch(console.error);
  }

  // Ø·Ù„Ø¨ ØªØ«Ø¨ÙŠØª PWA
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e=>{
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installBtn').style.display='inline-block';
  });
  document.getElementById('installBtn').onclick = ()=>{
    if(deferredPrompt){
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(()=>deferredPrompt=null);
    }
  };
  </script>
</body>
</html>
