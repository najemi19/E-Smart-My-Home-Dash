<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>E-Smart Market Pro — إدارة البيت</title>
  <meta name="theme-color" content="#D4AF37">

  <!-- Manifest مضمّن عبر Data URI -->
  <link rel="manifest" href="data:application/json;base64,ewogIm5hbWUiOiJFLVNtYXJ0IE1hcmtldCBQcm8iLCJzaG9ydF9uYW1lIjoiRS1TbWFydCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMEIwQjBCIiwi dGhlbWVfY29sb3IiOiIjRD RB RjM3In0=">

  <style>
    /* ========== CSS عام للمشروع ========== */
    :root {
      --bg: #0B0B0B;
      --panel: #111317;
      --gold: #D4AF37;
      --green: #22C55E;
      --muted: #9CA3AF;
      --white: #fff;
      --warn: #f59e0b;
      --danger: #ef4444;
      --line: #1f2937;
    }
    * { box-sizing: border-box; }
    html,body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--white);
      font-family: system-ui,Segoe UI,Inter,Noto Sans Arabic,Arial;
      height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 40px; height: 40px;
      border-radius: 10px;
      background: #000;
      border: 2px solid var(--gold);
      display: grid;
      place-items: center;
      color: var(--gold);
      font-weight: bold;
    }
    h1 { margin: 0; color: var(--gold); font-size: 1.2em; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--gold);
      background: transparent;
      color: var(--white);
      cursor: pointer;
    }
    .btn.primary { background: var(--gold); color: #000; border: none; }
    .tabs {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    .tab {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #333;
      background: transparent;
      color: var(--white);
      cursor: pointer;
    }
    .tab.active {
      border-color: var(--gold);
      background: var(--panel);
      color: var(--gold);
    }
    .panel {
      flex: 1;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      overflow: auto;
    }
    .panel h2 {
      margin-top: 0;
      color: var(--gold);
      font-size: 1em;
    }

    /* ========== Overrides وحدة المخزون ========== */
    #pantry form, #pantry .stock-list { margin-bottom: 16px; }
    #pantry form input,
    #pantry form select,
    #pantry form button {
      margin: 4px;
      padding: 6px;
      border: 1px solid #333;
      border-radius: 6px;
      background: #0b0b0b;
      color: #fff;
    }
    #pantry .stock-list .item {
      background: var(--panel);
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #pantry .btn.export { background: #ff7b00; border:none; color:#000; }
    #pantry .btn.import { background: #004aad; border:none; color:#fff; }
    #pantry .btn.reset  { background: var(--danger); border:none; }
    #pantry .btn.edit   { background: #ffc107; border:none; color:#000; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="logo">e</div>
        <h1>E-Smart Market Pro</h1>
      </div>
      <div class="actions">
        <button class="btn primary" id="installBtn">⬇️ تثبيت التطبيق</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="home">اللوحة</button>
      <button class="tab" data-tab="bills">الفواتير</button>
      <button class="tab" data-tab="pantry">المخزون</button>
      <button class="tab" data-tab="calendar">الرزنامة</button>
    </div>

    <!-- Home -->
    <section id="home" class="panel">
      <h2>ملخص سريع</h2>
      <p>هنا تعرض إحصائيات وأشكال بيانية…</p>
    </section>

    <!-- Bills -->
    <section id="bills" class="panel" style="display:none">
      <h2>الفواتير</h2>
      <p>واجهة إدارة الفواتير تأتي هنا.</p>
    </section>

    <!-- Pantry (المخزون) -->
    <section id="pantry" class="panel" style="display:none">
      <h2>المطبخ والمخزون</h2>

      <!-- إضافة/تعديل -->
      <form id="addProductForm">
        <input id="productName"    type="text" placeholder="اسم المنتج" required>
        <input id="productUnit"    type="text" placeholder="الوحدة (mg/ml/pc…)" required>
        <input id="productTotal"   type="number" placeholder="الكمية الكلية" required>
        <button class="btn primary" id="submitBtn">إضافة</button>
      </form>

      <!-- استهلاك -->
      <form id="consumeForm">
        <select id="productSelect"></select>
        <input id="consumeAmount"  type="number" placeholder="الكمية المستهلكة" required>
        <button class="btn">خصم</button>
      </form>

      <!-- تحكم تصدير/استيراد/مسح -->
      <button class="btn export" id="exportBtn">📤 تصدير JSON</button>
      <button class="btn import" id="importBtn">📥 استيراد JSON</button>
      <button class="btn reset"  id="resetBtn">🗑️ إعادة تعيين</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">

      <!-- قائمة -->
      <div class="stock-list" id="stockList"></div>
    </section>

    <!-- Calendar -->
    <section id="calendar" class="panel" style="display:none">
      <h2>الرزنامة</h2>
      <p>واجهة إدارة الأحداث هنا.</p>
    </section>
  </div>

  <script>
  // ===== تبديل التبويبات =====
  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
      document.getElementById(tab.dataset.tab).style.display='block';
    };
  });

  // ===== وحدة المخزون =====
  function initPantry(){
    let products = JSON.parse(localStorage.getItem("products"))||[];
    let editIndex = null;
    const refs = {
      addForm:       document.getElementById("addProductForm"),
      consumeForm:   document.getElementById("consumeForm"),
      exportBtn:     document.getElementById("exportBtn"),
      importBtn:     document.getElementById("importBtn"),
      resetBtn:      document.getElementById("resetBtn"),
      importFile:    document.getElementById("importFile"),
      productSelect: document.getElementById("productSelect"),
      stockList:     document.getElementById("stockList"),
      submitBtn:     document.getElementById("submitBtn"),
      nameInput:     document.getElementById("productName"),
      unitInput:     document.getElementById("productUnit"),
      totalInput:    document.getElementById("productTotal"),
      consumeInput:  document.getElementById("consumeAmount")
    };

    const saveData = ()=> {
      localStorage.setItem("products", JSON.stringify(products));
    };

    function updateUI(){
      // Dropdown
      refs.productSelect.innerHTML = "";
      products.forEach((p,i)=>{
        const o = document.createElement("option");
        o.value = i; o.textContent = p.name;
        refs.productSelect.appendChild(o);
      });
      // List
      refs.stockList.innerHTML = "";
      products.forEach((p,i)=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <span><strong>${p.name}</strong> — ${p.used}/${p.total}${p.unit}</span>
          <span><button class="btn edit" onclick="editProduct(${i})">✏️</button></span>
        `;
        refs.stockList.appendChild(div);
      });
    }

    window.editProduct = i=>{
      const p = products[i];
      refs.nameInput.value  = p.name;
      refs.unitInput.value  = p.unit;
      refs.totalInput.value = p.total;
      editIndex = i;
      refs.submitBtn.textContent = "تحديث";
    };

    refs.addForm.onsubmit = e=>{
      e.preventDefault();
      const name  = refs.nameInput.value;
      const unit  = refs.unitInput.value;
      const total = +refs.totalInput.value;
      if(editIndex!==null){
        products[editIndex] = {...products[editIndex], name, unit, total};
        editIndex = null;
        refs.submitBtn.textContent = "إضافة";
      } else {
        products.push({name,unit,total,used:0});
      }
      saveData();
      updateUI();
      refs.addForm.reset();
    };

    refs.consumeForm.onsubmit = e=>{
      e.preventDefault();
      const i   = +refs.productSelect.value;
      const amt = +refs.consumeInput.value;
      if(products[i].total - products[i].used >= amt){
        products[i].used += amt;
        saveData();
        updateUI();
      } else alert("⚠️ المخزون غير كافٍ!");
      refs.consumeForm.reset();
    };

    refs.exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(products,null,2)], {type:"application/json"});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href    = url;
      a.download= "stock-data.json";
      a.click();
      URL.revokeObjectURL(url);
    };

    refs.importBtn.onclick = ()=> refs.importFile.click();
    refs.importFile.onchange = e=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{
        try {
          const arr = JSON.parse(ev.target.result);
          if(Array.isArray(arr)){
            products = arr;
            saveData();
            updateUI();
            alert("✅ تم استيراد البيانات!");
          } else throw "";
        } catch {
          alert("⚠️ ملف غير صالح");
        }
      };
      r.readAsText(f);
    };

    refs.resetBtn.onclick = ()=>{
      if(confirm("⚠️ مسح كل البيانات؟")){
        products=[];
        localStorage.removeItem("products");
        updateUI();
        alert("✅ تم المسح!");
      }
    };

    updateUI();
  }
  // استدعاء وحدة المخزون عند فتح التبويب
  document.querySelector('[data-tab="pantry"]').addEventListener('click', initPantry);

  // ===== PWA & Service Worker =====
  if('serviceWorker' in navigator){
    // كود SW كـ Blob لتضمينه بنفس الملف
    const swCode = `
      const CACHE = 'esmart-cache-v1';
      self.addEventListener('install', e=>{
        e.waitUntil(
          caches.open(CACHE).then(c=>c.addAll([
            './',
          ]))
        );
        self.skipWaiting();
      });
      self.addEventListener('fetch', e=>{
        e.respondWith(
          caches.match(e.request).then(r=>r||fetch(e.request))
        );
      });
    `;
    const blob = new Blob([swCode],{type:'text/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).catch(console.error);
  }

  // طلب تثبيت PWA
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e=>{
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installBtn').style.display='inline-block';
  });
  document.getElementById('installBtn').onclick = ()=>{
    if(deferredPrompt){
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(()=>deferredPrompt=null);
    }
  };
  </script>
</body>
</html>
