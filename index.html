<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Eâ€‘Smart My Home Dash â€” Ø¥Ø¯Ø§Ø±Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ø¨ÙŠØª</title>
  <meta name="theme-color" content="#D4AF37">
  <style>
    :root{
      --bg:#0B0B0B; --panel:#111317; --line:#1f2937;
      --gold:#D4AF37; --green:#22C55E; --white:#fff; --muted:#9CA3AF;
      --warn:#f59e0b; --danger:#ef4444; --blue:#004aad; --orange:#ff7b00;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--white);font-family:system-ui,Segoe UI,Inter,"Noto Sans Arabic",Arial}
    .container{max-width:1200px;margin:auto;padding:16px;min-height:100vh;display:flex;flex-direction:column;gap:12px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:10px;border:2px solid var(--gold);display:grid;place-items:center;font-weight:800;color:var(--gold)}
    h1{margin:0;color:var(--gold);font-size:1.1rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--gold);background:transparent;color:var(--white);cursor:pointer}
    .btn.primary{background:var(--gold);border:none;color:#000}
    .btn.ghost{border-color:#333}
    .badges{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .badge{font-size:.8rem;border:1px solid #333;padding:4px 8px;border-radius:999px;color:var(--muted)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:8px;border:1px solid #333;background:transparent;color:var(--white);cursor:pointer}
    .tab.active{border-color:var(--gold);background:var(--panel);color:var(--gold)}
    .grid{display:grid;gap:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;min-height:220px}
    .panel h2{margin:0 0 10px;color:var(--gold);font-size:1rem}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select{background:#0b0b0b;border:1px solid #2a2a2a;color:#fff;border-radius:8px;padding:8px 10px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #222;padding:8px;text-align:start}
    tfoot td{font-weight:700}
    .muted{color:var(--muted)}
    .ok{color:var(--green)} .warn{color:var(--warn)} .danger{color:var(--danger)}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.split{grid-template-columns:1.2fr .8fr}}
    /* Pantry */
    #pantry .row > *{min-width:120px}
    #stockList .item{display:flex;justify-content:space-between;align-items:center;background:#0c0f14;border:1px solid #1a1f27;border-radius:10px;padding:10px;margin-bottom:8px}
    #stockList .qty{font-weight:700}
    .mini{font-size:.85rem}
    /* Bills print */
    @media print{
      .no-print{display:none !important}
      body{background:#fff;color:#000}
      .panel{border:none}
      table,th,td{border:1px solid #000;border-collapse:collapse}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">e</div>
        <div>
          <h1>Eâ€‘Smart My Home Dash</h1>
          <div class="badges">
            <span class="badge">PWA</span>
            <span class="badge">Offline</span>
            <span class="badge">AR/FR/AMZ-ready</span>
          </div>
        </div>
      </div>
      <div class="actions no-print">
        <button class="btn" id="syncBtn">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø©</button>
        <button class="btn ghost" id="exportAllBtn">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„</button>
        <button class="btn primary" id="installBtn">â¬‡ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
    </div>

    <div class="tabs no-print" id="tabs">
      <button class="tab active" data-tab="home">Ø§Ù„Ù„ÙˆØ­Ø©</button>
      <button class="tab" data-tab="bills">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
      <button class="tab" data-tab="pantry">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
      <button class="tab" data-tab="calendar">Ø§Ù„Ø±Ø²Ù†Ø§Ù…Ø©</button>
      <button class="tab" data-tab="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <section id="home" class="panel">
      <h2>Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
        <div class="panel">
          <div class="muted mini">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
          <div id="kpiProducts" class="ok" style="font-size:1.6rem">0</div>
        </div>
        <div class="panel">
          <div class="muted mini">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</div>
          <div id="kpiStockVal" style="font-size:1.6rem">â€”</div>
        </div>
        <div class="panel">
          <div class="muted mini">ÙÙˆØ§ØªÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
          <div id="kpiBills" style="font-size:1.6rem">0</div>
        </div>
        <div class="panel">
          <div class="muted mini">Ø£Ø­Ø¯Ø§Ø« Ù‚Ø§Ø¯Ù…Ø©</div>
          <div id="kpiEvents" style="font-size:1.6rem">0</div>
        </div>
      </div>
    </section>

    <section id="bills" class="panel" style="display:none">
      <h2>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
      <div class="split">
        <div class="panel">
          <div class="row">
            <input id="billCustomer" placeholder="Ø§Ù„Ø¹Ù…ÙŠÙ„">
            <input id="billDate" type="date">
            <button class="btn" id="newBillBtn">ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="itemName" placeholder="Ø§Ù„Ø¹Ù†ØµØ±">
            <input id="itemQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" value="1">
            <input id="itemPrice" type="number" step="0.01" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            <button class="btn" id="addItemBtn">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</button>
          </div>

          <table style="margin-top:10px">
            <thead>
              <tr><th>Ø§Ù„Ø¹Ù†ØµØ±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
            </thead>
            <tbody id="billItems"></tbody>
            <tfoot>
              <tr><td colspan="3">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td><td id="billTotal">0</td><td class="no-print"></td></tr>
            </tfoot>
          </table>

          <div class="row no-print" style="margin-top:10px">
            <button class="btn" id="saveBillBtn">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="btn" id="printBillBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="btn ghost" id="exportBillBtn">ğŸ“¤ ØªØµØ¯ÙŠØ± JSON</button>
            <button class="btn danger" id="resetBillBtn" style="border-color:var(--danger);color:var(--danger)">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
          </div>
        </div>

        <div class="panel">
          <div class="row">
            <input id="billSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„ØªØ§Ø±ÙŠØ®">
          </div>
          <div id="billsList" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <section id="pantry" class="panel" style="display:none">
      <h2>Ø§Ù„Ù…Ø·Ø¨Ø® ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
      <div class="panel">
        <div class="row">
          <input id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required>
          <input id="productUnit" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© (mg/ml/pcâ€¦)" required>
          <input id="productTotal" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©" required>
          <input id="productCost" type="number" step="0.01" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©/ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          <button class="btn primary" id="submitProductBtn">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div class="row">
          <select id="productSelect"></select>
          <input id="consumeAmount" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©">
          <button class="btn" id="consumeBtn">â– Ø®ØµÙ…</button>
        </div>
        <div class="row no-print">
          <button class="btn" id="exportProductsBtn" style="background:var(--orange);border:none;color:#000">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
          <button class="btn" id="importProductsBtn" style="background:var(--blue);border:none">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
          <input type="file" id="importProductsFile" accept="application/json" style="display:none">
          <button class="btn" id="resetProductsBtn" style="background:var(--danger);border:none">ğŸ—‘ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
        <div id="stockList" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="calendar" class="panel" style="display:none">
      <h2>Ø§Ù„Ø±Ø²Ù†Ø§Ù…Ø©</h2>
      <div class="split">
        <div class="panel">
          <div class="row">
            <input id="eventTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«">
            <input id="eventDate" type="date">
            <button class="btn" id="addEventBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
          </div>
          <table style="margin-top:10px">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
            <tbody id="eventsTbody"></tbody>
          </table>
        </div>
        <div class="panel">
          <div class="muted mini">ØªÙ„Ù…ÙŠØ­Ø§Øª</div>
          <ul>
            <li>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø²Ù†Ø§Ù…Ø© Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©.</li>
            <li>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØªÙØµØ¯Ù‘ÙØ± Ø¶Ù…Ù† "ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„".</li>
          </ul>
        </div>
      </div>
    </section>

    <section id="settings" class="panel" style="display:none">
      <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
        <div class="panel">
          <div class="muted mini">Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¨ØµØ±ÙŠØ©</div>
          <div class="row" style="margin-top:8px">
            <select id="langSelect">
              <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
              <option value="fr">FranÃ§ais</option>
              <option value="en">English</option>
            </select>
            <button class="btn" id="applyLangBtn">ØªØ·Ø¨ÙŠÙ‚</button>
          </div>
        </div>
        <div class="panel">
          <div class="muted mini">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="exportAllBtn2">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„</button>
            <input type="file" id="importAllFile" accept="application/json" style="display:none">
            <button class="btn" id="importAllBtn">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
  /* ============ Ø£Ø¯ÙˆØ§Øª ØªØ®Ø²ÙŠÙ† ============ */
  const db = {
    get: (k, def) => {
      try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; }
    },
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    del: (k) => localStorage.removeItem(k)
  };

  /* ============ ØªØ¨ÙˆÙŠØ¨Ø§Øª ============ */
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.onclick=()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('section.panel').forEach(p=>p.style.display='none');
      document.getElementById(tab.dataset.tab).style.display='block';
      if(tab.dataset.tab==='pantry') initPantryOnce();
      if(tab.dataset.tab==='bills') initBillsOnce();
      if(tab.dataset.tab==='calendar') initCalendarOnce();
    };
  });

  /* ============ KPI ============ */
  function refreshKPIs(){
    const products = db.get('products',[]);
    const invoices = db.get('invoices',[]);
    const events   = db.get('events',[]);
    document.getElementById('kpiProducts').textContent = products.length;
    // ØªÙ‚Ø¯ÙŠØ± Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† = Ù…Ø¬Ù…ÙˆØ¹ (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ * Ø§Ù„ØªÙƒÙ„ÙØ©/ÙˆØ­Ø¯Ø©) Ø¥Ù† ÙˆÙØ¬Ø¯Øª
    const val = products.reduce((s,p)=> s + ((p.total-p.used)*(Number(p.cost)||0)), 0);
    document.getElementById('kpiStockVal').textContent = val>0 ? val.toFixed(2) : 'â€”';
    const month = new Date().toISOString().slice(0,7);
    const thisMonth = invoices.filter(b => (b.date||'').startsWith(month)).length;
    document.getElementById('kpiBills').textContent = thisMonth;
    const upcoming = events.filter(e => e.date >= new Date().toISOString().slice(0,10)).length;
    document.getElementById('kpiEvents').textContent = upcoming;
  }

  /* ============ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ============ */
  let pantryInitialized=false;
  function initPantryOnce(){ if(!pantryInitialized){ pantryInitialized=true; initPantry(); } }

  function initPantry(){
    let products = db.get('products',[]);
    let editIndex = null;
    const refs = {
      name: document.getElementById('productName'),
      unit: document.getElementById('productUnit'),
      total: document.getElementById('productTotal'),
      cost: document.getElementById('productCost'),
      submit: document.getElementById('submitProductBtn'),
      sel: document.getElementById('productSelect'),
      consume: document.getElementById('consumeAmount'),
      consumeBtn: document.getElementById('consumeBtn'),
      list: document.getElementById('stockList'),
      exportBtn: document.getElementById('exportProductsBtn'),
      importBtn: document.getElementById('importProductsBtn'),
      importFile: document.getElementById('importProductsFile'),
      resetBtn: document.getElementById('resetProductsBtn')
    };

    function save(){ db.set('products', products); refreshKPIs(); }
    function render(){
      // dropdown
      refs.sel.innerHTML='';
      products.forEach((p,i)=> {
        const o=document.createElement('option'); o.value=i; o.textContent=p.name; refs.sel.appendChild(o);
      });
      // list
      refs.list.innerHTML='';
      products.forEach((p,i)=>{
        const item=document.createElement('div'); item.className='item';
        const remain = (p.total - p.used);
        item.innerHTML=`
          <div>
            <div><strong>${p.name}</strong> <span class="muted mini">(${p.unit})</span></div>
            <div class="mini">Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span>${p.used}</span> | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="qty ${remain<=0?'danger':remain<=(p.total*0.2)?'warn':'ok'}">${remain}</span> / ${p.total}</div>
            <div class="mini muted">ØªÙƒÙ„ÙØ©/ÙˆØ­Ø¯Ø©: ${p.cost?Number(p.cost):'-'}</div>
          </div>
          <div class="row no-print">
            <button class="btn" onclick="window.p_edit(${i})" style="background:#ffc107;border:none;color:#000">âœï¸</button>
            <button class="btn" onclick="window.p_delete(${i})" style="background:#222;border-color:#333">ğŸ—‘ï¸</button>
          </div>`;
        refs.list.appendChild(item);
      });
    }

    window.p_edit = (i)=>{
      const p=products[i];
      refs.name.value=p.name; refs.unit.value=p.unit; refs.total.value=p.total; refs.cost.value=p.cost||'';
      editIndex=i; refs.submit.textContent='ØªØ­Ø¯ÙŠØ«';
    };
    window.p_delete = (i)=>{
      if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')){ products.splice(i,1); save(); render(); }
    };

    refs.submit.onclick=(e)=>{
      e.preventDefault();
      const p = {
        name: refs.name.value.trim(),
        unit: refs.unit.value.trim(),
        total: Number(refs.total.value||0),
        used: editIndex!=null ? products[editIndex].used : 0,
        cost: refs.cost.value? Number(refs.cost.value) : null
      };
      if(!p.name || !p.unit || !(p.total>=0)) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©.');
      if(editIndex!=null){ products[editIndex] = p; editIndex=null; refs.submit.textContent='Ø¥Ø¶Ø§ÙØ©'; }
      else products.push(p);
      refs.name.value=refs.unit.value=refs.total.value=refs.cost.value='';
      save(); render();
    };

    refs.consumeBtn.onclick=(e)=>{
      e.preventDefault();
      const i=Number(refs.sel.value); const amt=Number(refs.consume.value||0);
      if(isNaN(i) || isNaN(amt) || amt<=0) return;
      if(products[i].total - products[i].used >= amt){ products[i].used += amt; save(); render(); refs.consume.value=''; }
      else alert('âš ï¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ!');
    };

    refs.exportBtn.onclick=()=>{
      const blob=new Blob([JSON.stringify(products,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='products.json'; a.click(); URL.revokeObjectURL(url);
    };
    refs.importBtn.onclick=()=>refs.importFile.click();
    refs.importFile.onchange=(e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=ev=>{
        try{
          const arr=JSON.parse(ev.target.result);
          if(Array.isArray(arr)){ products=arr; save(); render(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.'); }
          else throw 'bad';
        }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.'); }
      }; r.readAsText(f);
    };
    refs.resetBtn.onclick=()=>{
      if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŸ')){ products=[]; db.del('products'); render(); refreshKPIs(); }
    };

    render(); refreshKPIs();
  }

  /* ============ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ============ */
  let billsInitialized=false;
  function initBillsOnce(){ if(!billsInitialized){ billsInitialized=true; initBills(); } }

  function initBills(){
    let invoices = db.get('invoices',[]);
    let draft = db.get('bill_draft',{id:null,customer:'',date:'',items:[]});

    const r = {
      customer: document.getElementById('billCustomer'),
      date: document.getElementById('billDate'),
      newBtn: document.getElementById('newBillBtn'),
      itemName: document.getElementById('itemName'),
      itemQty: document.getElementById('itemQty'),
      itemPrice: document.getElementById('itemPrice'),
      addItem: document.getElementById('addItemBtn'),
      itemsT: document.getElementById('billItems'),
      total: document.getElementById('billTotal'),
      save: document.getElementById('saveBillBtn'),
      print: document.getElementById('printBillBtn'),
      export: document.getElementById('exportBillBtn'),
      reset: document.getElementById('resetBillBtn'),
      search: document.getElementById('billSearch'),
      list: document.getElementById('billsList')
    };

    function saveDraft(){ db.set('bill_draft', draft); }
    function sum(){ return draft.items.reduce((s,it)=> s + it.qty*it.price, 0); }
    function renderDraft(){
      r.customer.value=draft.customer||''; r.date.value=draft.date||'';
      r.itemsT.innerHTML='';
      draft.items.forEach((it,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${it.name}</td><td>${it.qty}</td><td>${it.price.toFixed(2)}</td><td>${(it.qty*it.price).toFixed(2)}</td>
        <td class="no-print"><button class="btn" onclick="window.b_rm(${i})">Ø­Ø°Ù</button></td>`;
        r.itemsT.appendChild(tr);
      });
      r.total.textContent = sum().toFixed(2);
    }
    window.b_rm = (i)=>{ draft.items.splice(i,1); saveDraft(); renderDraft(); };

    function renderList(){
      r.list.innerHTML='';
      const q=(r.search.value||'').toLowerCase();
      invoices
        .filter(b=> !q || (b.customer||'').toLowerCase().includes(q) || (b.date||'').includes(q))
        .slice(-50).reverse()
        .forEach((b,idx)=>{
          const div=document.createElement('div'); div.className='item';
          const total=b.items.reduce((s,it)=>s+it.qty*it.price,0).toFixed(2);
          div.style.cssText='background:#0c0f14;border:1px solid #1a1f27;border-radius:10px;padding:8px;margin-bottom:6px';
          div.innerHTML=`<div><strong>${b.customer||'â€”'}</strong> <span class="muted mini">(${b.date||'â€”'})</span></div>
                         <div class="mini">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total}</div>`;
          r.list.appendChild(div);
        });
    }

    r.newBtn.onclick=()=>{ draft={id:null,customer:'',date:new Date().toISOString().slice(0,10),items:[]}; saveDraft(); renderDraft(); };
    r.addItem.onclick=()=>{
      const name=r.itemName.value.trim(); const qty=Number(r.itemQty.value||0); const price=Number(r.itemPrice.value||0);
      if(!name || qty<=0 || price<0) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†ØµØ± ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
      draft.items.push({name,qty,price}); r.itemName.value=''; r.itemQty.value=1; r.itemPrice.value='';
      saveDraft(); renderDraft();
    };
    r.save.onclick=()=>{
      if(!draft.date) draft.date=new Date().toISOString().slice(0,10);
      invoices.push({id:Date.now(),customer:draft.customer,date:draft.date,items:[...draft.items]});
      db.set('invoices',invoices);
      draft={id:null,customer:'',date:'',items:[]}; saveDraft(); renderDraft(); renderList(); refreshKPIs();
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.');
    };
    r.print.onclick=()=>window.print();
    r.export.onclick=()=>{
      const blob=new Blob([JSON.stringify(draft,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='bill-draft.json'; a.click(); URL.revokeObjectURL(url);
    };
    r.reset.onclick=()=>{ if(confirm('Ù…Ø³Ø­ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ')){ draft.items=[]; saveDraft(); renderDraft(); } };
    r.customer.oninput=()=>{ draft.customer=r.customer.value; saveDraft(); };
    r.date.oninput=()=>{ draft.date=r.date.value; saveDraft(); };
    r.search.oninput=renderList;

    renderDraft(); renderList(); refreshKPIs();
  }

  /* ============ Ø§Ù„Ø±Ø²Ù†Ø§Ù…Ø© ============ */
  let calendarInitialized=false;
  function initCalendarOnce(){ if(!calendarInitialized){ calendarInitialized=true; initCalendar(); } }

  function initCalendar(){
    let events = db.get('events',[]);
    const t = {
      title: document.getElementById('eventTitle'),
      date: document.getElementById('eventDate'),
      add: document.getElementById('addEventBtn'),
      tbody: document.getElementById('eventsTbody')
    };

    function save(){ db.set('events',events); refreshKPIs(); }
    function render(){
      t.tbody.innerHTML='';
      events.sort((a,b)=> a.date.localeCompare(b.date));
      events.forEach((e,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${e.date}</td><td>${e.title}</td><td class="no-print"><button class="btn" onclick="window.e_del(${i})">Ø­Ø°Ù</button></td>`;
        t.tbody.appendChild(tr);
      });
    }
    window.e_del=(i)=>{ events.splice(i,1); save(); render(); };

    t.add.onclick=()=>{
      const title=t.title.value.trim(); const date=t.date.value;
      if(!title || !date) return;
      events.push({title,date}); t.title.value=''; t.date.value='';
      save(); render();
    };

    render(); refreshKPIs();
  }

  /* ============ ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø´Ø§Ù…Ù„ ============ */
  function exportAll(){
    const data = {
      products: db.get('products',[]),
      invoices: db.get('invoices',[]),
      bill_draft: db.get('bill_draft',{id:null,customer:'',date:'',items:[]}),
      events: db.get('events',[]),
      meta: { app:'Eâ€‘Smart My Home Dash', ts: Date.now() }
    };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='esmart-backup.json'; a.click(); URL.revokeObjectURL(url);
  }
  document.getElementById('exportAllBtn').onclick=exportAll;
  document.getElementById('exportAllBtn2').onclick=exportAll;
  document.getElementById('importAllBtn').onclick=()=>document.getElementById('importAllFile').click();
  document.getElementById('importAllFile').onchange=(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=ev=>{
      try{
        const d=JSON.parse(ev.target.result);
        if(!d || typeof d!=='object') throw 'bad';
        if(d.products) db.set('products',d.products);
        if(d.invoices) db.set('invoices',d.invoices);
        if(d.bill_draft) db.set('bill_draft',d.bill_draft);
        if(d.events) db.set('events',d.events);
        alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.');
        location.reload();
      }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.'); }
    }; r.readAsText(f);
  };

  /* ============ Ù…Ø²Ø§Ù…Ù†Ø© Ø®Ø§Ø¯Ù…ÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© ============ */
  document.getElementById('syncBtn').onclick=async()=>{
    const payload = {
      products: db.get('products',[]),
      invoices: db.get('invoices',[]),
      events: db.get('events',[])
    };
    try{
      const res = await fetch('/api/sync', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(res.ok){ const out=await res.json().catch(()=>({}));
        alert('âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø§Ø¬Ø­Ø©' + (out.message?(' â€” '+out.message):''));
      } else { alert('âš ï¸ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…ØªØ§Ø­ Ù„ÙƒÙ† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙØ´Ù„Øª.'); }
    }catch{
      alert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø§Ø¯Ù…. Ø§Ù„Ø¹Ù…Ù„ Ù…Ø³ØªÙ…Ø± Ø£ÙˆÙÙ„Ø§ÙŠÙ†.');
    }
  };

  /* ============ PWA: Manifest + Service Worker ============ */
  (function setupManifest(){
    const manifest = {
      name: "Eâ€‘Smart My Home Dash",
      short_name: "Eâ€‘Smart",
      start_url: "./",
      scope: "./",
      display: "standalone",
      background_color: "#0B0B0B",
      theme_color: "#D4AF37",
      icons: []
    };
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const link=document.createElement('link'); link.rel='manifest'; link.href=url;
    document.head.appendChild(link);
  })();

  if('serviceWorker' in navigator){
    const sw = `
      const CACHE='esmart-v1';
      const ASSETS=['./'];
      self.addEventListener('install',e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)));
        self.skipWaiting();
      });
      self.addEventListener('activate',e=>{
        e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
        self.clients.claim();
      });
      self.addEventListener('fetch',e=>{
        const req=e.request;
        e.respondWith(
          caches.match(req).then(cached=>{
            const fetchP = fetch(req).then(res=>{
              const copy = res.clone();
              caches.open(CACHE).then(c=>c.put(req,copy)).catch(()=>{});
              return res;
            }).catch(()=>cached);
            return cached || fetchP;
          })
        );
      });
    `;
    const blob=new Blob([sw],{type:'text/javascript'});
    const url=URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).catch(console.error);
  }

  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault(); deferredPrompt=e;
    document.getElementById('installBtn').style.display='inline-block';
  });
  document.getElementById('installBtn').onclick=()=>{
    if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.finally(()=> deferredPrompt=null); }
  };

  /* ============ Ù„ØºØ© ØµÙˆØ±ÙŠØ© ============ */
  document.getElementById('applyLangBtn').onclick=()=>{
    const lang=document.getElementById('langSelect').value;
    alert('ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ù„ØºØ©: '+lang+' (ÙˆØ§Ø¬Ù‡Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„ØºØ§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø¯Ù…Ø§Ø¬)');
  };

  /* ============ ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© ============ */
  refreshKPIs(); // KPIs Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  </script>
</body>
</html>
